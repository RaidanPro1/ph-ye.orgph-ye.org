<div class="bg-base-100 p-6 rounded-xl shadow h-full flex flex-col animate-fade-in">
  @if (selectedProject(); as project) {
    <!-- Project Header -->
    <div class="flex-shrink-0 pb-4 border-b border-gray-200">
      <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
        <div class="flex-grow">
          <label for="project-selector" class="text-sm font-medium text-gray-500">المشروع الحالي</label>
          <select id="project-selector" (change)="selectProject($event)" class="block w-full mt-1 p-2 text-2xl font-bold bg-base-100 border-0 border-b-2 border-gray-200 focus:ring-0 focus:border-ph-blue transition">
            @for(p of projects(); track p.id) {
              <option [value]="p.id" [selected]="p.id === project.id">{{ p.name }}</option>
            }
          </select>
        </div>
        <div class="flex items-center gap-2 flex-shrink-0">
          <div class="flex items-center -space-x-2">
            @for(member of project.team; track member.id) {
              <img class="w-10 h-10 rounded-full border-2 border-white object-cover" [src]="member.avatar" [alt]="member.name" [title]="member.name">
            }
          </div>
        </div>
      </div>
       <div class="mt-4">
        <div class="flex justify-between mb-1"><span class="text-base font-medium text-ph-blue">تقدم المشروع</span><span class="text-sm font-medium text-ph-blue">{{ projectProgress() }}%</span></div>
        <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-ph-blue h-2.5 rounded-full" [style.width.%]="projectProgress()"></div></div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="flex-shrink-0 border-b border-gray-200 mt-4">
       <div class="flex justify-between items-center">
        <nav class="-mb-px flex space-i-6" aria-label="Tabs">
            <button (click)="setTab('overview')" [class]="activeTab() === 'overview' ? 'border-ph-blue text-ph-blue' : 'border-transparent text-gray-500 hover:text-gray-700'" class="whitespace-nowrap py-4 px-2 border-b-2 font-medium text-sm">نظرة عامة</button>
            <button (click)="setTab('tasks')" [class]="activeTab() === 'tasks' ? 'border-ph-blue text-ph-blue' : 'border-transparent text-gray-500 hover:text-gray-700'" class="whitespace-nowrap py-4 px-2 border-b-2 font-medium text-sm">المهام</button>
            <button (click)="setTab('files')" [class]="activeTab() === 'files' ? 'border-ph-blue text-ph-blue' : 'border-transparent text-gray-500 hover:text-gray-700'" class="whitespace-nowrap py-4 px-2 border-b-2 font-medium text-sm">الملفات</button>
            <button (click)="setTab('discussion')" [class]="activeTab() === 'discussion' ? 'border-ph-blue text-ph-blue' : 'border-transparent text-gray-500 hover:text-gray-700'" class="whitespace-nowrap py-4 px-2 border-b-2 font-medium text-sm">النقاشات</button>
            @if (isWebRtcEnabled()) {
              <button (click)="setTab('meeting')" [class]="activeTab() === 'meeting' ? 'border-ph-blue text-ph-blue' : 'border-transparent text-gray-500 hover:text-gray-700'" class="whitespace-nowrap py-4 px-2 border-b-2 font-medium text-sm">اجتماع مباشر</button>
            }
        </nav>
      </div>
    </div>

    <!-- Tab Content -->
    <div class="flex-grow pt-6 overflow-hidden">
      @switch (activeTab()) {
        @case ('overview') {
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full overflow-y-auto">
            <div class="lg:col-span-2 space-y-6">
              <div class="bg-base-200/50 p-4 rounded-lg">
                <h3 class="font-bold mb-3">المهام القادمة</h3>
                <div class="space-y-2">
                  @for(task of upcomingTasks(); track task.id) {
                    <div class="bg-white p-3 rounded-md flex justify-between items-center">
                      <p class="text-sm font-semibold">{{task.title}}</p>
                      <span class="text-xs font-mono">{{task.dueDate}}</span>
                    </div>
                  } @empty { <p class="text-sm text-gray-500">لا توجد مهام قادمة.</p> }
                </div>
              </div>
            </div>
            <div class="bg-base-200/50 p-4 rounded-lg">
              <h3 class="font-bold mb-3">آخر النشاطات</h3>
               <ul class="space-y-4">
                @for(activity of recentActivity(); track $index) {
                    <li class="flex items-start gap-3">
                        <img [src]="activity.author.avatar" class="w-8 h-8 rounded-full object-cover flex-shrink-0">
                        <div>
                          <p class="text-sm text-gray-600">
                              <span class="font-semibold text-gray-800">{{ activity.author.name }}</span>
                              {{ activity.text }}
                          </p>
                           <p class="text-xs text-gray-400 mt-1">{{ activity.timestamp | date:'short' }}</p>
                        </div>
                    </li>
                } @empty { <p class="text-sm text-gray-500">لا توجد نشاطات حديثة.</p> }
              </ul>
            </div>
          </div>
        }
        @case ('tasks') {
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full">
            @for (status of ['todo', 'inProgress', 'done']; track status) {
              <div (dragover)="onDragOver($event, status)" (dragleave)="onDragLeave()" (drop)="onDrop($event, status)" class="flex flex-col bg-base-200/50 rounded-lg transition-all border-2 border-transparent" [class.border-dashed]="dragOverStatus() === status" [class.border-ph-blue]="dragOverStatus() === status">
                <h3 class="font-bold text-center p-2 rounded-t-lg flex justify-between items-center mx-2 mt-2">
                  @if (status === 'todo') { <span class="text-blue-800">المهام المطلوبة ({{filteredTasks().todo.length}})</span> }
                  @if (status === 'inProgress') { <span class="text-yellow-800">قيد التنفيذ ({{filteredTasks().inProgress.length}})</span> }
                  @if (status === 'done') { <span class="text-green-800">تم الإنجاز ({{filteredTasks().done.length}})</span> }
                </h3>
                <div class="p-3 space-y-3 h-full overflow-y-auto">
                  @for(task of filteredTasks()[status]; track task.id) {
                    <div (click)="openTaskDetailModal(task)" draggable="true" (dragstart)="onDragStart(task.id)" class="relative group p-3 bg-white rounded-lg shadow-sm cursor-pointer hover:shadow-md hover:border-ph-blue border border-transparent transition-all">
                      <div class="flex justify-between items-start">
                        <p class="font-semibold text-sm pe-4">{{ task.title }}</p>
                        <span class="text-xs font-bold px-2 py-0.5 rounded-full" [ngClass]="{'bg-red-100 text-red-800': task.priority === 'High', 'bg-yellow-100 text-yellow-800': task.priority === 'Medium', 'bg-green-100 text-green-800': task.priority === 'Low'}">
                          {{ task.priority === 'High' ? 'عالية' : (task.priority === 'Medium' ? 'متوسطة' : 'منخفضة') }}
                        </span>
                      </div>
                      <div class="flex justify-between items-center mt-3 text-xs text-gray-500">
                          <div class="flex items-center gap-3">
                            @if(task.subtasks.length > 0){
                              <span class="flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M1.75 3.25a.75.75 0 0 1 .75-.75h11a.75.75 0 0 1 0 1.5h-11a.75.75 0 0 1-.75-.75Zm0 5a.75.75 0 0 1 .75-.75h11a.75.75 0 0 1 0 1.5h-11a.75.75 0 0 1-.75-.75Zm0 5a.75.75 0 0 1 .75-.75h11a.75.75 0 0 1 0 1.5h-11a.75.75 0 0 1-.75-.75Z" clip-rule="evenodd" /></svg> {{ getCompletedSubtasksCount(task) }}/{{task.subtasks.length}}</span>
                            }
                            @if(task.comments.length > 0){
                              <span class="flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M1.75 2.5a.75.75 0 0 0-1.5 0v1.441c.08.64.442 1.223.957 1.635l.913.729a.75.75 0 0 0 .96-.062l.01-.012c.314-.36.755-.63 1.25-.785A3.99 3.99 0 0 1 8 4c2.21 0 4 1.79 4 4s-1.79 4-4 4a3.99 3.99 0 0 1-3.32-.953c-.5-.155-.935-.425-1.25-.785l-.01-.012a.75.75 0 0 0-.96-.062l-.913.73c-.515.411-.876.994-.957 1.634V13.5a.75.75 0 0 0 1.5 0v-1.129a2.49 2.49 0 0 1 .288-.972l.004-.007.01-.012 8.46-8.46a.75.75 0 0 0-1.06-1.06L2.01 9.382l-.011.012-.004.007a2.49 2.49 0 0 1-.288-.972V2.5Z" clip-rule="evenodd" /></svg> {{task.comments.length}}</span>
                            }
                            @if(task.attachments.length > 0){
                               <span class="flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M8.992 2.31a.75.75 0 0 0-1.06-.02L4.06 6.162a2.5 2.5 0 0 0 3.536 3.536l3.39-3.391a1.5 1.5 0 0 0-2.121-2.122L7.38 5.68a.75.75 0 0 0 1.06 1.061l1.485-1.485a.75.75 0 0 1 1.06 1.06l-3.39 3.39a1.5 1.5 0 0 1-2.122-2.12l1.486-1.486a.75.75 0 0 0-1.06-1.06L4.06 8.838a2.5 2.5 0 0 0 3.536 3.536l3.876-3.876a3.5 3.5 0 0 0-4.95-4.95L2.31 7.76a.75.75 0 0 0 1.06 1.06l4.212-4.211a2.001 2.001 0 0 1 2.83 0l.02.02Z" clip-rule="evenodd" /></svg> {{task.attachments.length}}</span>
                            }
                          </div>
                         <img [src]="task.assignee.avatar" [title]="task.assignee.name" class="w-6 h-6 rounded-full object-cover">
                      </div>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }
        @case ('files') {
          <div class="h-full overflow-y-auto">
            <button class="mb-4 px-4 py-2 text-sm font-medium text-white bg-ph-blue rounded-lg">رفع ملف</button>
            <!-- File list would go here -->
             <p class="text-gray-500">لا توجد ملفات في هذا المشروع بعد.</p>
          </div>
        }
        @case ('discussion') {
          <div class="h-full overflow-y-auto">
            <button class="mb-4 px-4 py-2 text-sm font-medium text-white bg-ph-blue rounded-lg">بدء نقاش جديد</button>
             @for(thread of project.discussionThreads; track thread.id) {
              <div class="bg-base-200 p-3 rounded-lg flex justify-between items-center mb-2">
                <div>
                  <p class="font-semibold">{{thread.title}}</p>
                  <p class="text-xs text-gray-500">بدأها {{thread.author.name}} • {{thread.replies}} ردود</p>
                </div>
                <span class="text-xs text-gray-400">آخر نشاط: {{thread.lastActivity}}</span>
              </div>
            } @empty {
              <p class="text-gray-500">لا توجد نقاشات في هذا المشروع بعد.</p>
            }
          </div>
        }
        @case ('meeting') { <app-webrtc-call></app-webrtc-call> }
      }
    </div>
  } @else { <p class="text-center text-gray-500">الرجاء اختيار مشروع للبدء.</p> }
</div>

<!-- Task Detail Modal -->
@if (isTaskDetailModalOpen() && selectedTask(); as task) {
  <div class="fixed inset-0 bg-black/60 z-40 flex items-center justify-center animate-fade-in" (click)="closeModals()">
    <div class="bg-base-100 rounded-lg shadow-xl w-full max-w-4xl h-[80vh] flex flex-col p-6" (click)="$event.stopPropagation()">
      <div class="flex-shrink-0 flex justify-between items-start border-b pb-4">
        <input type="text" [(ngModel)]="task.title" class="text-2xl font-bold w-full border-0 focus:ring-0 p-0">
        <button (click)="closeModals()" class="p-1 rounded-full hover:bg-gray-100">&times;</button>
      </div>
      <div class="flex-grow grid grid-cols-3 gap-6 overflow-hidden pt-4">
        <!-- Left Column: Details -->
        <div class="col-span-2 overflow-y-auto pr-4 space-y-4">
          <div><label class="font-semibold">الوصف</label><textarea [(ngModel)]="task.description" class="w-full border rounded-md mt-1 p-2 bg-gray-50" rows="4"></textarea></div>
          <div>
            <h4 class="font-semibold mb-2">المهام الفرعية</h4>
            @for(subtask of task.subtasks; track subtask.id){
              <div class="flex items-center gap-2 p-1 hover:bg-gray-100 rounded">
                <input type="checkbox" [(ngModel)]="subtask.isComplete" class="rounded">
                <input type="text" [(ngModel)]="subtask.title" class="flex-grow text-sm border-0 bg-transparent focus:ring-0 focus:bg-white p-1" [class.line-through]="subtask.isComplete">
              </div>
            }
            <form (submit)="$event.preventDefault(); addSubtask()" class="flex gap-2 mt-1"><input [(ngModel)]="newSubtaskTitle" name="newSubtask" placeholder="إضافة مهمة فرعية..." class="flex-grow text-sm border rounded p-1"><button type="submit" class="text-sm px-2 py-1 rounded bg-gray-200">إضافة</button></form>
          </div>
           <div>
            <h4 class="font-semibold mb-2">المرفقات</h4>
            <!-- Attachment list and upload would go here -->
            <p class="text-sm text-gray-400">لا توجد مرفقات.</p>
          </div>
        </div>
        <!-- Right Column: Meta & Activity -->
        <div class="col-span-1 overflow-y-auto space-y-4 bg-base-200/50 p-4 rounded-lg">
          <div class="space-y-3 text-sm">
            <div><span class="font-semibold w-20 inline-block">الحالة</span><span>قيد التنفيذ</span></div>
            <div><span class="font-semibold w-20 inline-block">الأولوية</span><span [class.text-red-600]="task.priority === 'High'">{{task.priority}}</span></div>
            <div><span class="font-semibold w-20 inline-block">تاريخ التسليم</span><span>{{task.dueDate}}</span></div>
            <div><span class="font-semibold w-20 inline-block">المسؤول</span><span class="flex items-center gap-2"><img [src]="task.assignee.avatar" class="w-5 h-5 rounded-full">{{task.assignee.name}}</span></div>
          </div>
          <hr>
          <div>
            <h4 class="font-semibold mb-2">النشاطات والتعليقات</h4>
            <div class="space-y-3">
              @for(comment of task.comments; track comment.id){
                <div class="flex items-start gap-2">
                  <img [src]="comment.author.avatar" class="w-6 h-6 rounded-full">
                  <div>
                    <p class="text-xs"><span class="font-bold">{{comment.author.name}}</span> <span class="text-gray-400">{{comment.timestamp | date:'short'}}</span></p>
                    <p class="text-sm bg-white p-2 rounded-md mt-1">{{comment.text}}</p>
                  </div>
                </div>
              }
            </div>
             <form (submit)="$event.preventDefault(); addTaskComment()" class="mt-4 flex gap-2">
              <input [(ngModel)]="newTaskComment" name="newTaskComment" placeholder="أضف تعليقاً..." class="flex-grow border rounded-md p-2 text-sm">
              <button type="submit" [disabled]="!newTaskComment()" class="px-4 py-2 text-sm bg-ph-blue text-white rounded-md disabled:bg-gray-400">إرسال</button>
            </form>
          </div>
        </div>
      </div>
       <div class="flex-shrink-0 pt-4 border-t mt-4 flex justify-end">
        <button (click)="saveTaskDetails()" class="px-6 py-2 bg-ph-blue text-white rounded-lg font-semibold">حفظ وإغلاق</button>
      </div>
    </div>
  </div>
}